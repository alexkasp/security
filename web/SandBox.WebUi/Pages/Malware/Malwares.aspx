<%@ Page Title="" Language="C#" MasterPageFile="~/Main.master" AutoEventWireup="true" CodeBehind="Malwares.aspx.cs" Inherits="SandBox.WebUi.Pages.Malware.Malwares" %>
<%@ Register TagPrefix="dxwgv" Namespace="DevExpress.Web.ASPxGridView" %>
<asp:Content ID="Content1" ContentPlaceHolderID="MainContent" runat="server">
<script type="text/javascript">
    function OnAddClick(element) {
        popup_upload.ShowAtElement(element);
    }

    function UpdateUploadButton() {
        btnUpload.SetEnabled(uploader.GetText(0) != "");
    }

    function Uploader_OnUploadStart() {
        btnUpload.SetEnabled(false);
    }
    function Uploader_OnFileUploadComplete(args) {
        if (args.isValid) {
            popup_upload.Hide();
            UpdateUploadButton();
        }
    }

    function OnDeleteClick(element, key) {
        popup_delete.ShowAtElement(element);
        callbackPanel_delete.PerformCallback(key);
    }

    function OnAcceptDelete() {
        popup_delete.Hide();
    }
</script>
   <asp:UpdatePanel ID="PopupDeletePanel" runat="server"  UpdateMode="Conditional">
    <ContentTemplate>
    <dx:ASPxPopupControl ID="popup_delete" ClientInstanceName="popup_delete" runat="server" AllowDragging="false" AllowResize="false" ShowCloseButton="false"
        PopupHorizontalAlign="OutsideRight" HeaderText="Удаление ВПО:">
        <ContentCollection>
           <dx:PopupControlContentControl ID="PopupControlContentControl3" runat="server">
                <dx:ASPxCallbackPanel ID="callbackPanel_delete" ClientInstanceName="callbackPanel_delete" runat="server"
                    Width="250px" Height="50px" OnCallback="CallbackPanelDeleteCallback" RenderMode="Table">
                    <PanelCollection>
                        <dx:PanelContent ID="PanelContent2" runat="server">              
                            <asp:Literal ID="deleteText" runat="server" Text=""></asp:Literal>
                            <dx:ASPxButton ID="btnDelete" runat="server" Text="удалить" 
                                AutoPostBack="False" OnClick="BtnDeleteClick">
                                <ClientSideEvents Click="OnAcceptDelete" />
                            </dx:ASPxButton>
                       </dx:PanelContent>
                    </PanelCollection>
                </dx:ASPxCallbackPanel>
            </dx:PopupControlContentControl>
        </ContentCollection>
    </dx:ASPxPopupControl>
    </ContentTemplate>
</asp:UpdatePanel>


    <asp:UpdatePanel ID="PopupUploadPanel" runat="server"  UpdateMode="Conditional">
    <ContentTemplate>
        <dx:ASPxPopupControl ID="popup_upload" ClientInstanceName="popup_upload" runat="server" AllowDragging="false" AllowResize="false" ShowCloseButton="false"
        PopupHorizontalAlign="OutsideRight" HeaderText="Загрузка ВПО на сервер:">
        <ContentCollection>
          <dx:PopupControlContentControl ID="PopupControlContentControl1" runat="server">
                <dx:ASPxCallbackPanel ID="callbackPanel_upload" ClientInstanceName="callbackPanel_upload" runat="server"
                    Width="200px" Height="50px" OnCallback="CallbackPanelUploadCallback" RenderMode="Table">
                    <PanelCollection>
                        <dx:PanelContent ID="PanelContent" runat="server">
                            <asp:Literal ID="litText" runat="server" Text="Выбирете файл для загрузки:"></asp:Literal>
                                    <dx:ASPxUploadControl ID="UploadControl" ClientInstanceName="uploader" runat="server" ShowProgressPanel="True"
                                            NullText="Нажмите, чтобы выбрать файл..." Size="35" OnFileUploadComplete="FileUploadComplete">
                                        <ValidationSettings FileDoesNotExistErrorText="Загружаемый файл не существует" 
                                            GeneralErrorText="Ошибка загрузки файла по причине внешней ошибки" 
                                            MaxFileSizeErrorText="Размер файла превышает макимально допустимый размер в {0} байт" 
                                            NotAllowedContentTypeErrorText="Тип содержимого запрещён" 
                                            NotAllowedFileExtensionErrorText="Расширение файла запрещено">
                                        </ValidationSettings>
                                        <ClientSideEvents FileUploadComplete="function(s, e) { Uploader_OnFileUploadComplete(e); }"
                                                FileUploadStart="function(s, e) { Uploader_OnUploadStart(); }">
                                        </ClientSideEvents>
                                    </dx:ASPxUploadControl>
                                    <dx:ASPxButton ID="btnUpload" ClientInstanceName="btnUpload" runat="server" OnClick="BtnUploadClick" Text="загрузить" AutoPostBack = "false">
                                      <ClientSideEvents Click="function(s, e) { uploader.Upload(); }"  />
                                    </dx:ASPxButton>
                        </dx:PanelContent>
                    </PanelCollection>
                </dx:ASPxCallbackPanel>
            </dx:PopupControlContentControl>
        </ContentCollection>    
    </dx:ASPxPopupControl>
    </ContentTemplate>
</asp:UpdatePanel>

<asp:UpdatePanel ID="UpdatePanelMalware" runat="server"  UpdateMode="Conditional">
    <ContentTemplate>
   
        <br />
        <a href="javascript:;" onclick="OnAddClick(this)">Загрузить новое ВПО на сервер</a>
        <br />
        <br />

        <dx:ASPxGridView ID="gridViewMalware" runat="server" 
            AutoGenerateColumns="False" EnableTheming="True" Theme="DevEx" 
            onheaderfilterfillitems="GridViewMalwareHeaderFilterFillItems" 
            onhtmlrowprepared="gridViewMalware_HtmlRowPrepared" KeyFieldName="Id">
            <Columns>
                <dx:GridViewCommandColumn VisibleIndex="0" Visible="False">
                </dx:GridViewCommandColumn>
                <dx:GridViewDataTextColumn Caption="Id" FieldName="Id" VisibleIndex="1" 
                    Visible=false>
                    <PropertiesTextEdit>
                        <ValidationSettings ErrorText="Неверное значение">
                            <RegularExpression ErrorText="Ошибка проверки регулярного выражения" />
                        </ValidationSettings>
                    </PropertiesTextEdit>
                </dx:GridViewDataTextColumn>
                <dx:GridViewDataColumn Caption="Наименование ВПО" FieldName="Name" 
                    VisibleIndex="1" Visible=false>
                </dx:GridViewDataColumn>
                <dx:GridViewDataColumn Caption="Исполняемый файл" FieldName="Path" 
                    VisibleIndex="2">
                </dx:GridViewDataColumn>
                <dx:GridViewDataColumn Caption="Классификация" FieldName="Class" 
                    VisibleIndex="3">
                </dx:GridViewDataColumn>
                <dx:GridViewDataTextColumn VisibleIndex="5">
                    <PropertiesTextEdit>
                        <ValidationSettings ErrorText="Неверное значение">
                            <RegularExpression ErrorText="Ошибка проверки регулярного выражения" />
                        </ValidationSettings>
                    </PropertiesTextEdit>
                    <DataItemTemplate>
                        <dx:ASPxHyperLink ID="HLMlwrCard" runat="server" Text="Карточка ВПО" 
                            NavigateUrl="~/Pages/Malware/MalwareCard.aspx" />
                    </DataItemTemplate>
                </dx:GridViewDataTextColumn>
                <dx:GridViewDataColumn Caption="Дополнительно" FieldName="Loaded" 
                    VisibleIndex="4">
                </dx:GridViewDataColumn>
                <dx:GridViewDataColumn Caption="" VisibleIndex="6">
                <DataItemTemplate>
                    <a href="javascript:;" onclick="OnDeleteClick(this, '<%# Container.KeyValue %>')">удалить</a>
                </DataItemTemplate>
            </dx:GridViewDataColumn>
            </Columns>
            <Settings ShowFilterRow="False" />
            <SettingsBehavior AllowFocusedRow="True" />
            <SettingsPager Visible="False">
            </SettingsPager>
            <SettingsLoadingPanel Text="Загрузка&amp;hellip;" />
        </dx:ASPxGridView>
        <asp:Timer ID="Update_timer" runat="server" Interval="1000" 
			 ontick="UpdateTimerTick">
		</asp:Timer>
        <dx:ASPxButton ID="ASPxButton1" runat="server" onclick="ASPxButton1_Click" 
            Text="Карточка ВПО" Visible="False">
        </dx:ASPxButton>
    </ContentTemplate>
    <Triggers>
         <asp:AsyncPostBackTrigger ControlID="gridViewMalware" EventName="DataBinding" />
    </Triggers>
</asp:UpdatePanel>
</asp:Content>
