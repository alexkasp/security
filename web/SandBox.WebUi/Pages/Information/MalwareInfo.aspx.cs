using System;
using DevExpress.Web.ASPxGridView;
using SandBox.Db;
using SandBox.Log;
using SandBox.WebUi.Base;
using DevExpress.Web.ASPxEditors;

namespace SandBox.WebUi.Pages.Information
{
    public partial class MalwareInfo : BaseMainPage
    {
        protected new void Page_Load(object sender, EventArgs e)
        {
            base.Page_Load(sender, e);
            PageTitle = "ВПО";
            PageMenu = "~/App_Data/SideMenu/Information/InformationMenu.xml";
            gridViewMalware.KeyFieldName = "Id";

            if (!IsPostBack)
            {
                if ((IsUserInRole("Administrator"))||(IsUserInRole("FileManager")))
                {
                    linkLoadNewMalware.Visible = true;
                }
                
                UpdateTableView();
            }
        }


        private void UpdateTableView()
        {
            if ((IsUserInRole("Administrator")) || (IsUserInRole("FileManager")))
            {
                foreach (GridViewDataColumn column in gridViewMalware.Columns)
                {
                    if (column.Name == "deleteColumn") column.Visible = true;
                }
            }

            labelMalwareInfo.Text = "Загружено " + MlwrManager.GetMlwrsCount() + " ВПО, не исследовано " + MlwrManager.GetMlwrsUnresearchedCount() + " ВПО";

            gridViewMalware.DataSource = MlwrManager.GetMlwrsTableView();
            gridViewMalware.DataBind();
        }

        protected void UpdateTimerTick(object sender, EventArgs e)
        {
           UpdateTableView();
        }

        protected void UpdateInfoTimerTick(object sender, EventArgs e)
        {
            labelMalwareInfo.Text = "Загружено " + MlwrManager.GetMlwrsCount() + " ВПО, не исследовано " + MlwrManager.GetMlwrsUnresearchedCount() + " ВПО";
        }

        protected void CallbackPanelDeleteCallback(object source, DevExpress.Web.ASPxClasses.CallbackEventArgsBase e)
        {
            Int32 mlwrId = Convert.ToInt32(e.Parameter);
            Session["mlwrId"] = mlwrId;
            if (mlwrId == 0) return;
            deleteText.Text = "Вы точно хотите удалить ВПО " + MlwrManager.GetMlwr(mlwrId).Path + "?";
        }

        protected void BtnDeleteClick(object sender, EventArgs e)
        {
            deleteText.Text = String.Empty;
            Int32 mlwrId = Convert.ToInt32(Session["mlwrId"]);
            if (mlwrId == 0) return;
            MLogger.LogTo(Level.TRACE, false, "Delete malware '" + MlwrManager.GetMlwr(mlwrId).Path + "' by user '" + UserManager.GetUser(UserId).UserName + "'");
            MlwrManager.DeleteMlwr(mlwrId);
        }

        protected void ASPxButton1_Click(object sender, EventArgs e)
        {
            Session["mlwrID"] = this.gridViewMalware.GetRowValues(this.gridViewMalware.FocusedRowIndex, "Id");
            Response.Redirect("~/Pages/Malware/MalwareCard.aspx");
        }

        protected void gridViewMalware_HtmlRowPrepared(object sender, ASPxGridViewTableRowEventArgs e)
        {
            if (e.RowType != DevExpress.Web.ASPxGridView.GridViewRowType.Data) return;
            ASPxHyperLink linkMlwr = gridViewMalware.FindRowCellTemplateControl(e.VisibleIndex, null, "mlwrID") as ASPxHyperLink;
            if (linkMlwr == null) return;
            int mlwId = (int)e.KeyValue;
            linkMlwr.NavigateUrl += "?mlwrID=" + mlwId;
        }
    }//end class
}//end namespace