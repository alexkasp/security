using System;
using System.Net;
using DevExpress.Web.ASPxUploadControl;
using SandBox.Db;
using SandBox.Log;
using SandBox.WebUi.Base;

namespace SandBox.WebUi.Pages.Information
{
    public partial class LoadMalware : BaseMainPage
    {
        protected new void Page_Load(object sender, EventArgs e)
        {
            base.Page_Load(sender, e);
            PageTitle = "Загрузка ВПО";
            PageMenu  = "~/App_Data/SideMenu/Information/InformationMenu.xml";

            if (!IsPostBack)
            {
                if (!IsUserInRole("Administrator"))
                {
                    if (!IsUserInRole("FileManager"))
                    {
                        Response.Redirect("~/Account/Login.aspx");
                    }
                }
            }
        }

        protected void FileUploadComplete(object sender, FileUploadCompleteEventArgs e)
        {
            if (e.UploadedFile.FileName != String.Empty)
            {
                e.CallbackData = e.UploadedFile.FileName;

                try
                {
                    var settings = ConnectionManager.LoadSettings();
                    String ftpAddres = "ftp://" + settings.RemoteHost + "/" + e.UploadedFile.FileName;

                    MLogger.LogTo(Level.TRACE, false, "Uploading file " + e.UploadedFile.FileName + " to " + ftpAddres);

                    using (var webClient = new WebClient())
                    {
                        webClient.UploadData(new Uri(ftpAddres), e.UploadedFile.FileBytes);
                    }

                    MlwrManager.AddMlwr("default", e.UploadedFile.FileName, UserId);
                    MLogger.LogTo(Level.TRACE, false, "Add malware '" + e.UploadedFile.FileName + "' by user '" + UserManager.GetUser(UserId).UserName + "'");
                }
                catch (Exception ex)
                {
                    MLogger.LogTo(Level.ERROR, false, "Exception during uploading: " + ex.Message);
                }
            }
            Response.Redirect("~/Pages/Information/MalwareInfo.aspx");
        }
    }//end class
}//end namespace